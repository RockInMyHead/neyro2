#!/bin/bash

# ะัััััะน ััะฐัั ะธัะฟัะฐะฒะปะตะฝะธั nginx ะดะปั TimeWeb
echo "๐ ะัััััะน ััะฐัั ะธัะฟัะฐะฒะปะตะฝะธั nginx..."
echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะจะฐะณ 1: ะกะดะตะปะฐะตะผ ะฒัะต ัะบัะธะฟัั ะธัะฟะพะปะฝัะตะผัะผะธ
echo "๐ ะจะฐะณ 1: ะะพะดะณะพัะพะฒะบะฐ ัะบัะธะฟัะพะฒ"
chmod +x diagnose-nginx.sh
chmod +x manual-fix.sh
chmod +x fix-nginx-universal.sh
echo "โ ะกะบัะธะฟัั ะฟะพะดะณะพัะพะฒะปะตะฝั"

# ะจะฐะณ 2: ะะฐะฟัััะธะผ ะดะธะฐะณะฝะพััะธะบั
echo "๐ ะจะฐะณ 2: ะะธะฐะณะฝะพััะธะบะฐ"
sudo ./diagnose-nginx.sh

# ะจะฐะณ 3: ะกะฟัะพัะธะผ ะฟะพะปัะทะพะฒะฐัะตะปั ะบะฐะบะพะน ะผะตัะพะด ะธัะฟะพะปัะทะพะฒะฐัั
echo "๐ ะจะฐะณ 3: ะัะฑะพั ะผะตัะพะดะฐ ะธัะฟัะฐะฒะปะตะฝะธั"
echo "ะัะฑะตัะธัะต ะผะตัะพะด ะธัะฟัะฐะฒะปะตะฝะธั:"
echo "1) ะััะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต (ะดะปั ัะฐะนะปะฐ /etc/nginx/sites-enabled/neyro)"
echo "2) ะฃะฝะธะฒะตััะฐะปัะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต (ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฟะพะธัะบ ะบะพะฝัะธะณะฐ)"
echo "3) ะัะพะฟัััะธัั ะธัะฟัะฐะฒะปะตะฝะธั ะธ ัะพะปัะบะพ ะทะฐะฟัััะธัั backend"

read -p "ะะฒะตะดะธัะต ะฝะพะผะตั ะผะตัะพะดะฐ (1-3): " choice

case $choice in
    1)
        echo "๐ง ะะฐะฟััะบะฐั ัััะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต..."
        sudo ./manual-fix.sh
        ;;
    2)
        echo "๐ง ะะฐะฟััะบะฐั ัะฝะธะฒะตััะฐะปัะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต..."
        sudo ./fix-nginx-universal.sh
        ;;
    3)
        echo "โญ๏ธ  ะัะพะฟััะบะฐั ะธัะฟัะฐะฒะปะตะฝะธั nginx"
        ;;
    *)
        echo "โ ะะตะฒะตัะฝัะน ะฒัะฑะพั, ะธัะฟะพะปัะทัั ัััะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต"
        sudo ./manual-fix.sh
        ;;
esac

# ะจะฐะณ 4: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
echo "๐ ะจะฐะณ 4: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ"
echo "๐ ะัะพะฒะตััั backend ัะตัะฒะตั..."
if curl -s http://127.0.0.1:8000/docs > /dev/null; then
    echo "โ Backend ัะตัะฒะตั ัะฐะฑะพัะฐะตั"
else
    echo "โ Backend ัะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั"
    echo "๐ง ะะพะฟััะบะฐ ะทะฐะฟัััะธัั backend..."
    nohup python app.py > backend.log 2>&1 &
    sleep 3
    if curl -s http://127.0.0.1:8000/docs > /dev/null; then
        echo "โ Backend ัะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ"
    else
        echo "โ ะะต ัะดะฐะปะพัั ะทะฐะฟัััะธัั backend"
        echo "๐ ะะพะณะธ: $(cat backend.log 2>/dev/null || echo 'ะะพะณ ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ')"
    fi
fi

echo "๐ ะัะพะฒะตััั API ะดะพัััะฟะฝะพััั..."
curl -I http://194.87.226.56/generate_dalle

echo "โ ะัััััะน ััะฐัั ะทะฐะฒะตััะตะฝ!"
echo "๐ ะัะพะฒะตัััะต ะฒะฐั ัะฐะนั: http://194.87.226.56"
echo "๐ ะะพะดัะพะฑะฝะฐั ะธะฝััััะบัะธั: QUICK-FIX.md"