#!/bin/bash

echo "๐ ะะฐะฟััะบ backend ัะตัะฒะตัะฐ..."

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd /home/neyro/neyro2

# ะัะพะฒะตััะตะผ, ะทะฐะฟััะตะฝ ะปะธ ัะถะต ัะตัะฒะตั
if pgrep -f "uvicorn.*app:app" > /dev/null; then
    echo "โ๏ธ  ะกะตัะฒะตั ัะถะต ะทะฐะฟััะตะฝ. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ..."
    pkill -f "uvicorn.*app:app"
    sleep 2
fi

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะตัะปะธ ะตััั
if [ -d "venv" ]; then
    echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    source venv/bin/activate
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธะธ ะตัะปะธ ะธั ะฝะตั
mkdir -p images
mkdir -p music

# ะัะพะฒะตััะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
if ! python3 -c "import fastapi" 2>/dev/null; then
    echo "โ FastAPI ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ..."
    pip install -r requirements.txt
fi

# ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั
echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ ะฝะฐ ะฟะพััั 8003..."
export PYTHONPATH=/app
nohup uvicorn app:app --host 0.0.0.0 --port 8003 > backend.log 2>&1 &

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 5

# ะัะพะฒะตััะตะผ ััะฐััั
if pgrep -f "uvicorn.*app:app" > /dev/null; then
    echo "โ ะกะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ PID: $(pgrep -f 'uvicorn.*app:app')"
    echo "๐ URL: http://localhost:8003"
    echo "๐ ะะพะณะธ: tail -f backend.log"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: cat backend.log"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั
echo "๐ ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ..."
if curl -s http://localhost:8003/docs > /dev/null; then
    echo "โ API ะดะพัััะฟะตะฝ ะฝะฐ localhost:8003"
else
    echo "โ API ะฝะตะดะพัััะฟะตะฝ ะฝะฐ localhost:8003"
fi

echo ""
echo "๐ Backend ัะตัะฒะตั ะทะฐะฟััะตะฝ!"
echo "๐ ะัะพะฒะตัััะต ะฒะฐั ัะฐะนั: http://194.87.226.56" 